# Ideal Setup: Talos + Terraform (Zero-Touch GitOps)

Goal: Minimum manual work, maximum automation.

## Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    ARCHITECTURE                              │
│                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │   HUMAN     │────▶│  TERRAFORM  │────▶│   DOPPLER   │   │
│  │  (root      │     │  (creates   │     │  (stores    │   │
│  │   tokens)   │     │   infra)    │     │   secrets)  │   │
│  └─────────────┘     └──────┬──────┘     └──────┬──────┘   │
│                             │                    │          │
│                             ▼                    │          │
│                      ┌─────────────┐             │          │
│                      │   TALOS     │             │          │
│                      │  (K8s OS)   │             │          │
│                      └──────┬──────┘             │          │
│                             │                    │          │
│                             ▼                    │          │
│                      ┌─────────────┐             │          │
│                      │   ARGOCD    │◀────────────┘          │
│                      │  (GitOps)   │   (ExternalSecrets)    │
│                      └─────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 0: Manual Prerequisites (30 min, once ever)

### Create Accounts

| Service | URL | What to create |
|---------|-----|----------------|
| Cloudflare | dash.cloudflare.com | Account + add domain |
| Auth0 | auth0.com | Tenant |
| Tailscale | tailscale.com | Account + Tailnet |
| Doppler | doppler.com | Workspace |
| GitHub | github.com | Account + repos |

### Create Root API Tokens

| Service | Token Type | Permissions |
|---------|------------|-------------|
| Cloudflare | API Token | Zone, Tunnel, R2, Rulesets, DNS |
| Auth0 | Management API | Applications, APIs, Connections |
| Tailscale | API Key | All |
| Tailscale | OAuth Client | Devices, Auth keys |
| Doppler | Personal Token | Write access |
| GitHub | PAT | Repo access (if private) |

### Store Root Tokens

```
1Password / Bitwarden vault:
├── cloudflare-api-token
├── auth0-client-id
├── auth0-client-secret
├── tailscale-api-key
├── tailscale-oauth-client-id
├── tailscale-oauth-client-secret
├── doppler-personal-token
└── github-pat (optional)
```

---

## Phase 1: Terraform Bootstrap

### Repository Structure

```
infrastructure/
├── terraform/
│   ├── bootstrap/           # Run locally first time
│   │   ├── main.tf
│   │   ├── doppler.tf       # Create Doppler structure
│   │   └── outputs.tf
│   │
│   ├── cloudflare/          # Run via GitHub Actions
│   │   ├── tunnel.tf
│   │   ├── dns.tf
│   │   ├── r2.tf
│   │   ├── cache.tf
│   │   └── outputs → Doppler
│   │
│   ├── auth0/               # Run via GitHub Actions
│   │   ├── applications.tf
│   │   ├── apis.tf
│   │   ├── connections.tf
│   │   └── outputs → Doppler
│   │
│   ├── tailscale/           # Run via GitHub Actions
│   │   ├── acls.tf
│   │   ├── dns.tf
│   │   ├── authkeys.tf
│   │   └── outputs → Doppler
│   │
│   └── talos/               # Generate machine configs
│       ├── controlplane.tf
│       ├── worker.tf
│       └── outputs → machine configs
│
├── talos/
│   ├── controlplane.yaml    # Generated by Terraform
│   └── worker.yaml          # Generated by Terraform
│
└── ... (ArgoCD apps, charts, etc.)
```

### Bootstrap Flow

```bash
# 1. Clone repo
git clone https://github.com/user/infrastructure
cd infrastructure/terraform/bootstrap

# 2. Create terraform.tfvars (from password manager)
cat > terraform.tfvars << 'EOF'
cloudflare_api_token = "xxx"
auth0_client_id      = "xxx"
auth0_client_secret  = "xxx"
tailscale_api_key    = "xxx"
doppler_token        = "xxx"
EOF

# 3. Bootstrap Doppler structure
terraform init
terraform apply

# 4. Run other Terraform configs (or push to trigger GitHub Actions)
cd ../cloudflare && terraform init && terraform apply
cd ../auth0 && terraform init && terraform apply
cd ../tailscale && terraform init && terraform apply

# 5. Generate Talos configs
cd ../talos && terraform init && terraform apply
```

---

## Phase 2: Talos Server Setup

### What is Talos?

- Immutable Linux OS built for Kubernetes
- No SSH, no shell (API-only via `talosctl`)
- Entire config in YAML (machine config)
- Secure by default (read-only filesystem)
- Automatic updates (A/B partitioning)

### Talos Machine Config (generated by Terraform)

```yaml
# controlplane.yaml
version: v1alpha1
machine:
  type: controlplane
  token: <generated>

  network:
    hostname: k8s-cp-1
    interfaces:
      - interface: eth0
        dhcp: true

  install:
    disk: /dev/sda
    image: ghcr.io/siderolabs/installer:v1.9.0

  # Talos extensions (Tailscale, etc.)
  extensions:
    - image: ghcr.io/siderolabs/tailscale:1.76.1

  # Tailscale config (authkey from Terraform → Doppler)
  files:
    - path: /var/etc/tailscale/auth.env
      permissions: 0600
      contents: |
        TS_AUTHKEY={{ .tailscale_authkey }}
        TS_EXTRA_ARGS=--advertise-tags=tag:k8s

    # Bootstrap secret for ExternalSecrets
    - path: /var/run/secrets/doppler-token
      permissions: 0600
      contents: {{ .doppler_infra_shared_token }}

cluster:
  clusterName: smhomelab
  controlPlane:
    endpoint: https://k8s.example.com:6443

  # Bootstrap ArgoCD and ExternalSecrets
  inlineManifests:
    - name: argocd-namespace
      contents: |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: argocd

    - name: external-secrets-namespace
      contents: |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: external-secrets

    - name: doppler-bootstrap-secret
      contents: |
        apiVersion: v1
        kind: Secret
        metadata:
          name: doppler-token-infra-shared
          namespace: external-secrets
        type: Opaque
        stringData:
          dopplerToken: {{ .doppler_infra_shared_token }}

    - name: argocd-install
      contents: |
        # ArgoCD Helm release or kustomize
        ...
```

### Server Bootstrap Flow

```bash
# 1. Boot server from Talos ISO (USB or IPMI)
#    Server gets IP via DHCP

# 2. Apply machine config (from your workstation via Tailscale)
talosctl apply-config \
  --nodes 192.168.1.100 \
  --file controlplane.yaml \
  --insecure

# 3. Bootstrap Kubernetes
talosctl bootstrap --nodes 192.168.1.100

# 4. Get kubeconfig
talosctl kubeconfig --nodes 192.168.1.100

# 5. Verify
kubectl get nodes
kubectl get pods -n argocd
```

---

## Phase 3: GitOps Takes Over

After Talos bootstrap, ArgoCD manages everything:

```
ArgoCD App of Apps
│
├── Wave 0: CRDs
│   └── external-secrets-crds
│
├── Wave 1: Core
│   ├── external-secrets-operator
│   ├── cert-manager
│   └── cluster-secret-stores (Doppler)
│
├── Wave 2: Network
│   ├── cloudflared (token from Doppler)
│   ├── tailscale-operator
│   ├── external-dns
│   └── nginx-ingress
│
├── Wave 3: Auth
│   └── oauth2-proxy (Auth0 creds from Doppler)
│
├── Wave 4: Storage
│   └── longhorn
│
├── Wave 5: Data
│   ├── cloudnative-pg
│   └── redis-operator
│
├── Wave 6: Monitoring
│   ├── kube-prometheus-stack
│   ├── loki
│   └── alloy
│
└── Wave N: Applications
    └── your services
```

---

## Doppler Structure (Final)

```
smhomelub/                    # Application secrets
├── dev                       # Dev environment
└── prd                       # Production environment

smhomelub-infra/              # Infrastructure secrets
├── cicd                      # GitHub Actions (Terraform)
│   ├── R2_ACCESS_KEY_ID
│   ├── R2_SECRET_ACCESS_KEY
│   ├── CLOUDFLARE_API_TOKEN
│   ├── AUTH0_CLIENT_ID       # Management API
│   ├── AUTH0_CLIENT_SECRET
│   ├── TAILSCALE_API_KEY
│   ├── TAILSCALE_OAUTH_CLIENT_ID
│   ├── TAILSCALE_OAUTH_CLIENT_SECRET
│   └── DOPPLER_TOKEN         # Write access to 'shared'
│
└── shared                    # K8s infrastructure workloads
    ├── CF_TUNNEL_TOKEN       ← Terraform cloudflare output
    ├── CF_API_TOKEN          ← For external-dns
    ├── AUTH0_DOMAIN          ← Terraform auth0 output
    ├── AUTH0_CLIENT_ID       ← oauth2-proxy app
    ├── AUTH0_CLIENT_SECRET   ← oauth2-proxy app
    ├── TS_AUTHKEY            ← Terraform tailscale output
    └── ... (other infra secrets)
```

---

## Terraform Outputs → Doppler

Each Terraform module writes outputs to Doppler:

```hcl
# cloudflare/tunnel.tf
resource "doppler_secret" "tunnel_token" {
  project = "smhomelub-infra"
  config  = "shared"
  name    = "CF_TUNNEL_TOKEN"
  value   = cloudflare_zero_trust_tunnel_cloudflared.main.tunnel_token
}

# auth0/applications.tf
resource "doppler_secret" "oauth2_proxy_client_id" {
  project = "smhomelub-infra"
  config  = "shared"
  name    = "AUTH0_CLIENT_ID"
  value   = auth0_client.oauth2_proxy.client_id
}

resource "doppler_secret" "oauth2_proxy_client_secret" {
  project = "smhomelub-infra"
  config  = "shared"
  name    = "AUTH0_CLIENT_SECRET"
  value   = auth0_client.oauth2_proxy.client_secret
}

# tailscale/authkeys.tf
resource "doppler_secret" "ts_authkey" {
  project = "smhomelub-infra"
  config  = "shared"
  name    = "TS_AUTHKEY"
  value   = tailscale_tailnet_key.k8s.key
}
```

---

## Values Injection

### Secrets (sensitive)

```
Terraform → Doppler → ExternalSecrets → K8s Secret → Pod
```

### Configs (non-sensitive)

Option A: In git (values.yaml)
```yaml
# values.yaml
auth0:
  domain: myapp.auth0.com
tailscale:
  tailnet: mynet.ts.net
```

Option B: Also in Doppler (recommended)
```
Terraform → Doppler → ExternalSecrets → K8s ConfigMap → Pod
```

---

## Disaster Recovery

### What to backup

| Item | Backup Method |
|------|---------------|
| Doppler secrets | Doppler handles it (cloud) |
| Terraform state | R2 bucket (versioned) |
| Talos machine config | Git repo |
| K8s workloads | Git repo (GitOps) |
| Persistent data | Velero → R2 |
| Databases | CNPG → R2 |

### Recovery flow

```bash
# 1. Root tokens from password manager
# 2. terraform apply (recreates all infra)
# 3. Boot new server with Talos
# 4. talosctl apply-config (from git)
# 5. ArgoCD syncs everything
# 6. Velero restores PVs
# 7. CNPG restores databases
```

---

## Summary: What's Manual vs Automated

| Task | Frequency | Method |
|------|-----------|--------|
| Create cloud accounts | Once ever | Manual |
| Create root API tokens | Once/year | Manual |
| Store in password manager | Once/year | Manual |
| Run initial terraform | Once | Manual (local) |
| Boot server with Talos | Once per server | Manual (USB/IPMI) |
| Apply Talos config | Once per server | `talosctl` command |
| Everything else | Always | **Automated** |

---

## Next Steps

1. [ ] Finish current Doppler migration (cloudflared token mode)
2. [ ] Add Auth0 Terraform module
3. [ ] Add Tailscale Terraform module
4. [ ] Research Talos machine config generation
5. [ ] Test Talos on VM first
6. [ ] Migrate production server to Talos

---

## Sources

- [Talos Linux](https://www.talos.dev/)
- [Talos Getting Started](https://www.talos.dev/v1.9/introduction/getting-started/)
- [Talos + Tailscale](https://www.talos.dev/v1.9/talos-guides/configuration/tailscale/)
- [Doppler Terraform Provider](https://docs.doppler.com/docs/terraform)
- [External Secrets Operator](https://external-secrets.io/)
